<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¤§æ˜é èˆª â€”â€” éº’éºŸä¹‹èª“ 3D</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              imperial: {
                gold: '#C5A059',
                red: '#8B1E1E',
                ocean: '#1B365D',
                ink: '#2C1810',
                parchment: '#F0E6D2',
                parchment_dark: '#E6D5B8',
              },
              game: {
                trust: '#B91C1C',
                morale: '#0F766E',
                accent: '#C5A059',    
              }
            },
            fontFamily: {
              serif: ['"Noto Serif TC"', 'STSong', '"Songti SC"', 'serif'],
              sans: ['"Microsoft YaHei"', 'sans-serif'],
            },
            animation: {
              'fadeIn': 'fadeIn 0.5s ease-out',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0', transform: 'translateY(10px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              }
            }
          }
        }
      }
    </script>
    <style>
      body { margin: 0; padding: 0; background: radial-gradient(circle at center, #1e3a8a 0%, #0f172a 100%); overflow: hidden; }
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: #E6D5B8; }
      ::-webkit-scrollbar-thumb { background: #8B1E1E; border-radius: 3px; }
    </style>
    
    <!-- Import Map -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "react-globe.gl": "https://esm.sh/react-globe.gl@2.27.2",
    "lucide-react": "https://esm.sh/lucide-react@0.292.0",
    "@google/genai": "https://esm.sh/@google/genai@0.1.1",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>

    <!-- Process Shim -->
    <script>
      window.process = { env: { API_KEY: '' } };
    </script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react,typescript" data-type="module">
      import React, { useState, useEffect, useRef, useMemo } from 'react';
      import ReactDOM from 'react-dom/client';
      import Globe from 'react-globe.gl';
      import { Clock, AlertTriangle, Skull, Minimize2, Maximize2, Ship, MapPin, Box, Loader2, MessageSquare, Send, X } from 'lucide-react';
      import { GoogleGenAI } from "@google/genai";

      // --- CONSTANTS & DATA ---

      const LOCATIONS = [
        { id: 'nanjing', name: 'Nanjing', nameCn: 'å—äº¬ (åŠ‰å®¶æ¸¯)', lat: 31.5, lng: 121.1, description: 'æ˜æœèˆªæµ·èµ·é»ï¼Œå…­åœ‹ç¢¼é ­ã€‚', tradeGoods: ['çµ²ç¶¢', 'ç“·å™¨'] },
        { id: 'champa', name: 'Champa', nameCn: 'å åŸ', lat: 13.9, lng: 109.3, description: 'ä»Šè¶Šå—å—éƒ¨ï¼Œé‡è¦çš„é¦–å€‹è£œçµ¦ç«™ã€‚', tradeGoods: ['ç¨»ç±³', 'çƒæœ¨'] },
        { id: 'palembang', name: 'Palembang', nameCn: 'èˆŠæ¸¯', lat: -2.97, lng: 104.77, description: 'å‰¿æ»…æµ·ç›œé™³ç¥–ç¾©ä¹‹åœ°ã€‚', tradeGoods: ['é¦™æ–™'] },
        { id: 'malacca', name: 'Malacca', nameCn: 'æ»¿å‰ŒåŠ ', lat: 2.2, lng: 102.25, description: 'æˆ°ç•¥æµ·å³½æ§åˆ¶é»ï¼Œè¨­æœ‰å®˜å» ã€‚', tradeGoods: ['éŒ«', 'å€‰å„²'] },
        { id: 'semudera', name: 'Semudera', nameCn: 'è˜‡é–€ç­”è…Š', lat: 5.18, lng: 97.14, description: 'è˜‡é–€ç­”è‡˜åŒ—éƒ¨ï¼Œæ›¾ç™¼ç”Ÿè˜‡å¹²å‰Œå›äº‚ã€‚', tradeGoods: ['èƒ¡æ¤’', 'ç¡«ç£º'] },
        { id: 'ceylon', name: 'Ceylon', nameCn: 'éŒ«è˜­', lat: 6.9, lng: 79.8, description: 'ä½›ç‰™å¯ºæ‰€åœ¨åœ°ï¼Œæ›¾ç™¼ç”Ÿè¡çªã€‚', tradeGoods: ['å¯¶çŸ³', 'çç '] },
        { id: 'indianocean', name: 'Indian Ocean', nameCn: 'å°åº¦æ´‹', lat: 0, lng: 88, description: 'å»£è¢¤çš„æµ·æ´‹ï¼Œéœ€ç‰½æ˜Ÿè¡“å°èˆªã€‚', tradeGoods: [] },
        { id: 'calicut', name: 'Calicut', nameCn: 'å¤é‡Œ', lat: 11.25, lng: 75.78, description: 'è¥¿æ´‹å¤§æ¸¯ï¼Œä¸»è¦è²¿æ˜“ä¸­å¿ƒã€‚', tradeGoods: ['èƒ¡æ¤’', 'æ£‰å¸ƒ'] },
        { id: 'hormuz', name: 'Hormuz', nameCn: 'å¿½é²è°Ÿæ–¯', lat: 27.1, lng: 56.4, description: 'æ³¢æ–¯ç£é–€æˆ¶ï¼Œæ¥µå…¶å¯Œåº¶ã€‚', tradeGoods: ['åœ°æ¯¯', 'é¦¬åŒ¹'] },
        { id: 'bengal', name: 'Bengal', nameCn: 'æ¦œè‘›å‰Œ', lat: 23.0, lng: 90.0, description: 'é€²è²¢éº’éºŸä¹‹åœ‹ã€‚', tradeGoods: ['é•·é ¸é¹¿'] },
      ];

      const ROUTES = [
        { start: 'nanjing', end: 'champa', voyages: [1] },
        { start: 'champa', end: 'palembang', voyages: [1] },
        { start: 'palembang', end: 'malacca', voyages: [1] },
        { start: 'malacca', end: 'semudera', voyages: [1] },
        { start: 'semudera', end: 'ceylon', voyages: [1] },
        { start: 'ceylon', end: 'calicut', voyages: [1] },
        { start: 'calicut', end: 'hormuz', voyages: [1] },
        { start: 'calicut', end: 'bengal', voyages: [1] },
      ];

      const QUIZ_QUESTIONS = [
          { question: 'é„­å’Œä¸‹è¥¿æ´‹å§‹æ–¼å“ªä½çš‡å¸åœ¨ä½æœŸé–“ï¼Ÿ', options: ['æ˜å¤ªç¥–æœ±å…ƒç’‹', 'æ˜æˆç¥–æœ±æ££', 'æ˜ä»å®—æœ±é«˜ç†¾', 'æ˜å®£å®—æœ±ç»åŸº'], correct: 1, explanation: 'å§‹æ–¼æ˜æˆç¥–æœ±æ££æ°¸æ¨‚ä¸‰å¹´ï¼ˆ1405å¹´ï¼‰ã€‚' },
          { question: 'é„­å’Œçš„è‰¦éšŠæœ€é åˆ°é”å“ªå€‹åœ°å€ï¼Ÿ', options: ['æ—¥æœ¬', 'å°åº¦', 'éæ´²æ±å²¸', 'æ­æ´²'], correct: 2, explanation: 'æœ€é åˆ°é”éæ´²æ±å²¸ï¼Œå¦‚æœ¨éª¨éƒ½æŸï¼ˆä»Šç´¢é¦¬åˆ©äºï¼‰ã€‚' },
          { question: 'é„­å’Œä¸€å…±é€²è¡Œäº†å¤šå°‘æ¬¡ä¸‹è¥¿æ´‹çš„èˆªè¡Œï¼Ÿ', options: ['äº”æ¬¡', 'å…­æ¬¡', 'ä¸ƒæ¬¡', 'å…«æ¬¡'], correct: 2, explanation: 'å‰å¾Œæ­·æ™‚è¿‘ä¸‰åå¹´ï¼Œå…±ä¸ƒæ¬¡ã€‚' },
          { question: 'é„­å’ŒåŸåé¦¬ä¸‰ä¿ï¼Œä»–çš„å®—æ•™ä¿¡ä»°æ˜¯ä»€éº¼ï¼Ÿ', options: ['ä½›æ•™', 'é“æ•™', 'ä¼Šæ–¯è˜­æ•™', 'åŸºç£æ•™'], correct: 2, explanation: 'ä»–æ˜¯å›æ—ç©†æ–¯æ—ï¼Œä¿¡ä»°ä¼Šæ–¯è˜­æ•™ã€‚' },
          { question: 'é„­å’Œè‰¦éšŠä¸­æœ€å¤§çš„èˆ¹éš»è¢«ç¨±ç‚ºä»€éº¼ï¼Ÿ', options: ['æˆ°èˆ¹', 'å¯¶èˆ¹', 'é¾èˆ¹', 'ç¦èˆ¹'], correct: 1, explanation: 'æœ€å¤§çš„èˆ¹éš»ç¨±ç‚ºã€Œå¯¶èˆ¹ã€ã€‚' },
          { question: 'é„­å’Œä¸‹è¥¿æ´‹çš„ä¸»è¦ç›®çš„æ˜¯ä»€éº¼ï¼Ÿ', options: ['æ å¥ªè²¡å¯Œ', 'å®£æšåœ‹å¨', 'å°‹æ‰¾æ–°å¤§é™¸', 'å‚³æ’­åŸºç£æ•™'], correct: 1, explanation: 'ç›®çš„æ˜¯ã€Œå®£å¾·åŒ–è€ŒæŸ”é äººã€ï¼Œå®£æšåœ‹å¨èˆ‡ç™¼å±•æœè²¢è²¿æ˜“ã€‚' },
          { question: 'é„­å’Œåœ¨èˆŠæ¸¯ï¼ˆä»Šå°å°¼å·¨æ¸¯ï¼‰æ“Šæ•—äº†å“ªå€‹æµ·ç›œï¼Ÿ', options: ['å¼µä¿ä»”', 'é™³ç¥–ç¾©', 'ç‹ç›´', 'é„­èŠé¾'], correct: 1, explanation: 'æ“Šæ•—ä¸¦ç”Ÿæ“’äº†æµ·ç›œç‹é™³ç¥–ç¾©ã€‚' },
          { question: 'é„­å’Œè‰¦éšŠä½¿ç”¨ä»€éº¼æ–¹æ³•åœ¨æµ·ä¸Šç¢ºå®šæ–¹ä½ï¼Ÿ', options: ['GPS', 'ç‰½æ˜Ÿè¡“', 'é›·é”', 'ç„¡ç·šé›»'], correct: 1, explanation: 'ä½¿ç”¨ã€Œç‰½æ˜Ÿè¡“ã€è§€æ¸¬æ˜Ÿè±¡å®šä½ã€‚' },
          { question: 'é¦¬æ­¡è‘—æœ‰å“ªæœ¬è¨˜éŒ„èˆªè¡Œè¦‹èçš„æ›¸ç±ï¼Ÿ', options: ['ã€Šå³¶å¤·èªŒç•¥ã€‹', 'ã€Šç€›æ¶¯å‹è¦½ã€‹', 'ã€Šè¥¿æ´‹ç•ªåœ‹å¿—ã€‹', 'ã€Šæµ·åœ‹åœ–å¿—ã€‹'], correct: 1, explanation: 'é¦¬æ­¡è‘—æœ‰ã€Šç€›æ¶¯å‹è¦½ã€‹ã€‚' },
          { question: 'ã€Œè¥¿æ´‹ã€ä¸»è¦æŒ‡çš„æ˜¯å“ªå€‹æµ·åŸŸï¼Ÿ', options: ['å¤ªå¹³æ´‹', 'å¤§è¥¿æ´‹', 'å°åº¦æ´‹åŠæ±å—äº', 'åŒ—å†°æ´‹'], correct: 2, explanation: 'æŒ‡æ–‡èŠä»¥è¥¿çš„æ±å—äºåŠå°åº¦æ´‹æµ·åŸŸã€‚' },
          { question: 'æ¦œè‘›å‰Œåœ‹é€²è²¢çš„ã€Œéº’éºŸã€å¯¦éš›ä¸Šæ˜¯ä»€éº¼ï¼Ÿ', options: ['å¤§è±¡', 'é•·é ¸é¹¿', 'ç…å­', 'çŠ€ç‰›'], correct: 1, explanation: 'å¯¦éš›ä¸Šæ˜¯é•·é ¸é¹¿ã€‚' },
          { question: 'é„­å’Œåœ¨å“ªå€‹åœ°æ–¹è¨­ç«‹äº†ã€Œå®˜å» ã€ï¼Ÿ', options: ['å åŸ', 'æ»¿å‰ŒåŠ ', 'éŒ«è˜­', 'å¤é‡Œ'], correct: 1, explanation: 'åœ¨æ»¿å‰ŒåŠ ï¼ˆé¦¬å…­ç”²ï¼‰è¨­ç«‹äº†å®˜å» ä½œç‚ºè£œçµ¦åŸºåœ°ã€‚' },
          { question: 'é„­å’Œè‰¦éšŠçš„è¦æ¨¡å¤§ç´„æœ‰å¤šå°‘äººï¼Ÿ', options: ['ä¸€åƒäºº', 'äº”åƒäºº', 'äºŒè¬ä¸ƒåƒäºº', 'åè¬äºº'], correct: 2, explanation: 'é¦–æ¬¡å‡ºèˆªç´„æœ‰äºŒè¬ä¸ƒåƒå…«ç™¾é¤˜äººã€‚' },
          { question: 'é„­å’Œä¸‹è¥¿æ´‹å¾Œï¼Œæ˜æœå¯¦è¡Œä»€éº¼æ”¿ç­–å°è‡´è¡°é€€ï¼Ÿ', options: ['é–‹æ”¾è²¿æ˜“', 'æµ·ç¦æ”¿ç­–', 'æ®–æ°‘æ“´å¼µ', 'èˆªæµ·é¼“å‹µ'], correct: 1, explanation: 'æ˜æœå¾Œä¾†å¯¦è¡Œæµ·ç¦æ”¿ç­–ï¼Œåœæ­¢äº†å¤§è¦æ¨¡é èˆªã€‚' },
          { question: 'é„­å’Œè¢«è³œå§“ã€Œé„­ã€æ˜¯å› ç‚ºï¼Ÿ', options: ['å‡ºç”Ÿé„­å·', 'é–é›£ä¹‹å½¹ç«‹åŠŸ', 'ç¥–å…ˆå§“é„­', 'ä¿¡å¥‰ç¥æ˜'], correct: 1, explanation: 'å› åœ¨é–é›£ä¹‹å½¹ï¼ˆé„­æ‘å£©æˆ°å½¹ï¼‰ç«‹åŠŸï¼Œæœ±æ££è³œå§“é„­ã€‚' }
      ];

      const GAME_EVENTS = [
        {
            stage: 1, locationId: 'nanjing', icon: 'ğŸŒŠ', title: 'å•Ÿèˆªãƒ»å—æµ·é¢¨é›²',
            description: 'è‰¦éšŠé§›é›¢åŠ‰å®¶æ¸¯ï¼Œé€²å…¥å—æµ·ã€‚å‰æ–¹çƒé›²å¯†ä½ˆï¼Œé¢¨æš´å°‡è‡³ã€‚',
            choices: [
                { title: 'ã€ç©©å¥ã€‘é¿é–‹é¢¨æš´', effects: { trust: -10, morale: 5 }, successText: 'è¡Œç¨‹å»¶èª¤ï¼Œçš‡å¸å°é€²åº¦æ„Ÿåˆ°ä¸æ»¿ã€‚', autoSuccess: true },
                { title: 'ã€å­¸è­˜ã€‘è§€æ˜Ÿæ‰¾èˆªé“', requirement: { stat: 'knowledge', value: 4 }, requirementText: 'éœ€å­¸è­˜â‰¥4', effects: { trust: 10, morale: 5 }, failEffects: { trust: -15, morale: -20 }, successText: 'åˆ©ç”¨ç‰½æ˜Ÿè¡“æˆåŠŸç©¿è¶Šï¼', failText: 'åˆ¤æ–·å¤±èª¤ï¼Œèˆ¹éš»å—æï¼Œä¿¡ä»»å¤§æ¸›ã€‚', needsChallenge: true },
                { title: 'ã€æ¿€å‹µã€‘å¼·è¡Œé€šé', requirement: { stat: 'connections', value: 3 }, requirementText: 'éœ€äººè„ˆâ‰¥3', effects: { trust: 15, morale: -10 }, failEffects: { trust: -5, morale: -30 }, successText: 'èˆ¹å“¡çˆ†ç™¼å‹‡æ°£ç©¿è¶Šé¢¨æš´ï¼', failText: 'æå¤±æ…˜é‡ï¼Œå£«æ°£ä½è½ã€‚', needsChallenge: true }
            ]
        },
        {
            stage: 2, locationId: 'champa', icon: 'ğŸŒ´', title: 'å åŸãƒ»åˆæ¬¡é‚¦äº¤',
            description: 'æŠµé”é¦–ç«™å åŸï¼Œåœ‹ç‹æ…‹åº¦è¬¹æ…ï¼Œä¸çŸ¥å¤§æ˜ä¾†æ„ã€‚',
            choices: [
                { title: 'ã€å¨æ‡¾ã€‘å±•ç¤ºå¯¦åŠ›', effects: { trust: 5, morale: 5 }, failEffects: { trust: -10, morale: -5 }, successText: 'æ—Œæ——è”½æ—¥ï¼Œåœ‹ç‹éœ‡æ‡¾ã€‚', failText: 'éæ–¼å¼µæšï¼Œå¼•ç™¼æˆ’å¿ƒï¼Œæœ‰æåœ‹é«”ã€‚', needsChallenge: true },
                { title: 'ã€å’Œå¹³ã€‘è´ˆé€ç¦®ç‰©', requirementText: 'è€—éŠ€20', cost: { silver: 20 }, effects: { trust: 0, morale: 5, connections: 1 }, successText: 'å»ºç«‹å‹å¥½é—œä¿‚ï¼Œç²å–è£œçµ¦ã€‚', autoSuccess: true },
                { title: 'ã€æ–‡åŒ–ã€‘å±•ç¤ºæ–‡æ˜', requirement: { stat: 'knowledge', value: 3 }, requirementText: 'éœ€å­¸è­˜â‰¥3', effects: { trust: 5, morale: 5, knowledge: 1 }, successText: 'è»Ÿå¯¦åŠ›å¤–äº¤è´å¾—äººå¿ƒã€‚', autoSuccess: true }
            ]
        },
        {
            stage: 3, locationId: 'palembang', icon: 'ğŸ´â€â˜ ï¸', title: 'èˆŠæ¸¯ãƒ»æµ·ç›œé™³ç¥–ç¾©',
            description: 'æµ·ç›œç‹é™³ç¥–ç¾©ç›¤æ“šæ–¼æ­¤ï¼Œå‡æ„æ­¸é™ï¼Œå¯¦å‰‡æš—è—æ®ºæ©Ÿã€‚',
            choices: [
                { title: 'ã€æ­¦åŠ›ã€‘å…¨åŠ›é€²æ”»', requirementText: 'è€—éŠ€30', cost: { silver: 30 }, effects: { trust: 15, morale: -15 }, failEffects: { trust: -20, morale: -30 }, successText: 'ç”Ÿæ“’é™³ç¥–ç¾©ï¼Œå¨éœ‡å—æ´‹ï¼', failText: 'æå¤±æ…˜é‡ï¼Œçš‡å¸éœ‡æ€’ã€‚', needsChallenge: true },
                { title: 'ã€å¤–äº¤ã€‘è«‡åˆ¤æ‹›å®‰', requirement: { stat: 'connections', value: 5 }, requirementText: 'éœ€äººè„ˆâ‰¥5', effects: { trust: 5, morale: 5, connections: 1 }, failEffects: { trust: -15, morale: -10 }, successText: 'åˆ†åŒ–äº†æµ·ç›œå‹¢åŠ›ã€‚', failText: 'è«‡åˆ¤ç ´è£‚ï¼Œä½¿è€…è¢«æ‰£ã€‚', needsChallenge: true },
                { title: 'ã€æ™ºå–ã€‘è­˜ç ´è©é™', requirement: { stat: 'knowledge', value: 5 }, requirementText: 'éœ€å­¸è­˜â‰¥5', effects: { trust: 20, morale: 5 }, failEffects: { trust: -10, morale: -15 }, successText: 'å°‡è¨ˆå°±è¨ˆï¼Œä¸€èˆ‰æ®²æ»…ï¼', failText: 'è¨ˆåŠƒæœ‰æ¼ï¼Œæœªèƒ½å…¨æ®²ã€‚', needsChallenge: true },
                { title: 'ã€é˜²ç¦¦ã€‘åš´åŠ æˆ’å‚™', effects: { trust: -5, morale: -5 }, successText: 'é›–ç„¶ä¿å…¨äº†è‰¦éšŠï¼Œä½†æœªèƒ½å‰¿æ»…æµ·ç›œï¼Œç•™æœ‰å¾Œæ‚£ã€‚', autoSuccess: true }
            ]
        },
        { stage: 4, locationId: 'malacca', icon: 'ğŸï¸', title: 'æ»¿å‰ŒåŠ ãƒ»å»ºç«‹å®˜å» ', description: 'æŠµé”æˆ°ç•¥è¦åœ°æ»¿å‰ŒåŠ ï¼Œæš¹ç¾…åœ¨å´è™è¦–çœˆçœˆã€‚', choices: [{ title: 'å†Šå°åœ‹ç‹', effects: { trust: 10, morale: 5 }, successText: 'å…©åœ‹æ­£å¼å»ºäº¤ã€‚', autoSuccess: true }, { title: 'å»ºç«‹å®˜å» ', requirementText: 'è€—éŠ€40', cost: { silver: 40 }, effects: { trust: 10, morale: 10, connections: 1 }, successText: 'å»ºç«‹ç©©å›ºè£œçµ¦åŸºåœ°ã€‚', autoSuccess: true }, { title: 'èª¿è§£ç´›çˆ­', requirement: { stat: 'connections', value: 4 }, requirementText: 'éœ€äººè„ˆâ‰¥4', effects: { trust: 15, morale: 10, connections: 1 }, failEffects: { trust: -5, morale: -5 }, successText: 'å±•ç¾å¤§åœ‹èª¿åœèƒ½åŠ›ã€‚', needsChallenge: true }] },
        { stage: 5, locationId: 'semudera', icon: 'ğŸŒ‹', title: 'è˜‡é–€ç­”è‡˜ãƒ»ç«å±±', description: 'ç«å±±å™´ç™¼ï¼Œé®å¤©è”½æ—¥ï¼Œæ¼æ°‘é©šæ…Œé€ƒé›£ã€‚', choices: [{ title: 'ç·Šæ€¥æ’¤é›¢', effects: { trust: -5, morale: 5 }, successText: 'å®‰å…¨ç¬¬ä¸€ï¼Œå…¨å“¡æ’¤é›¢ï¼Œä½†éŒ¯å¤±è€ƒå¯Ÿæ©Ÿæœƒã€‚', autoSuccess: true }, { title: 'æ•‘åŠ©ç½æ°‘', requirementText: 'è€—éŠ€25', cost: { silver: 25 }, effects: { trust: 5, morale: 10 }, successText: 'ä»ç¾©ä¹‹å¸«ï¼Œè´å¾—æ°‘å¿ƒã€‚', autoSuccess: true }, { title: 'ç§‘å­¸è§€å¯Ÿ', requirement: { stat: 'knowledge', value: 4 }, requirementText: 'éœ€å­¸è­˜â‰¥4', effects: { trust: 5, knowledge: 2 }, successText: 'ç•™ä¸‹çè²´ç´€éŒ„ã€‚', autoSuccess: true }] },
        { stage: 6, locationId: 'ceylon', icon: 'ğŸ’', title: 'éŒ«è˜­ãƒ»ä½›ç‰™å¯º', description: 'åœ‹ç‹äºçƒˆè‹¦å¥ˆå…’è¨­ä¼ï¼Œæ„åœ–åŠ«æŒè‰¦éšŠã€‚', choices: [{ title: 'çªè¥²ç‹å®®', requirement: { stat: 'knowledge', value: 5 }, requirementText: 'éœ€å­¸è­˜â‰¥5', effects: { trust: 25, morale: -5 }, failEffects: { trust: -20, morale: -20 }, successText: 'è­˜ç ´è©­è¨ˆï¼Œç”Ÿæ“’åœ‹ç‹ï¼', needsChallenge: true }, { title: 'å©‰æ‹’å…¥å®®', effects: { trust: 0, morale: 5 }, successText: 'è¬¹æ…è¡Œäº‹ï¼Œé¿é–‹é™·é˜±ã€‚', autoSuccess: true }, { title: 'åƒæ‹œä½›ç‰™', requirement: { stat: 'connections', value: 5 }, requirementText: 'éœ€äººè„ˆâ‰¥5|è€—éŠ€30', cost: {silver:30}, effects: { trust: 10, connections:1 }, successText: 'çˆ­å–äº†ç•¶åœ°æ°‘å¿ƒã€‚', needsChallenge: true }] },
        { stage: 7, locationId: 'indianocean', icon: 'ğŸŒ…', title: 'å°åº¦æ´‹ãƒ»ç„¡é¢¨å¸¶', description: 'æµ·é¢å¹³éœå¦‚é¡ï¼Œå¸†èˆ¹ç„¡æ³•å‹•å½ˆï¼Œæ·¡æ°´å‘Šæ€¥ã€‚', choices: [{ title: 'åš´æ ¼é…çµ¦', effects: { trust: 0, morale: -20 }, successText: 'è‰±é›£åº¦éå±æ©Ÿï¼Œèˆ¹å“¡æ€¨è²è¼‰é“ã€‚', autoSuccess: true }, { title: 'ç¥­ç¥€ç¥ˆé¢¨', requirementText: 'è€—éŠ€25', cost: { silver: 25 }, effects: { trust: 0, morale: 15 }, successText: 'æµ·ç¥åº‡ä½‘ï¼Œé¢¨èµ·å¸†æšï¼', autoSuccess: true }, { title: 'ç§‘å­¸æ‡‰å°', requirement: { stat: 'knowledge', value: 5 }, requirementText: 'éœ€å­¸è­˜â‰¥5', effects: { trust: 10, knowledge: 1 }, successText: 'åˆ©ç”¨æ´‹æµæ¨é€²ï¼Œå±•ç¾æ™ºæ…§ã€‚', needsChallenge: true }] },
        { 
            stage: 8, locationId: 'calicut', icon: 'ğŸ•Œ', title: 'å¤é‡Œãƒ»é¦™æ–™è²¿æ˜“', description: 'æŠµé”è¥¿æ´‹è²¿æ˜“ä¸­å¿ƒï¼Œå„åœ‹å•†è³ˆé›²é›†ã€‚', 
            choices: [
                { title: 'ç°½è¨‚å”å®š', requirementText: 'è€—éŠ€50', cost: { silver: 50 }, effects: { trust: 15, silver: 30 }, successText: 'è²¿æ˜“ç²åˆ©è±åšã€‚', autoSuccess: true }, 
                { title: 'å®‰æ’«å•†äºº', requirement: { stat: 'connections', value: 5 }, requirementText: 'éœ€äººè„ˆâ‰¥5', effects: { trust: 5, connections: 1 }, failEffects: { trust: -5, morale: -10 }, successText: 'åŒ–è§£äº†å•†æ¥­æ•µæ„ã€‚', needsChallenge: true },
                { title: 'æ–‡åŒ–è€ƒå¯Ÿ', requirement: { stat: 'knowledge', value: 4 }, requirementText: 'éœ€å­¸è­˜â‰¥4', effects: { trust: 5, knowledge: 2 }, successText: 'è±å¯Œäº†å°è¥¿æ´‹çš„èªçŸ¥ã€‚', autoSuccess: true },
                { title: 'ã€åƒ…ä½œè£œçµ¦ã€‘', effects: { trust: -5 }, successText: 'å®Œæˆäº†åŸºæœ¬è£œçµ¦ï¼Œç©ºæ‰‹è€Œæ­¸ã€‚', autoSuccess: true }
            ] 
        },
        { stage: 9, locationId: 'hormuz', icon: 'ğŸº', title: 'å¿½é­¯è¬¨æ–¯ãƒ»ç–«ç—…', description: 'æ¸¯å£çˆ†ç™¼ç–«ç—…ï¼Œäººå¿ƒæƒ¶æƒ¶ã€‚', choices: [{ title: 'éš”é›¢é˜²ç–«', effects: { trust: -5, morale: -10 }, successText: 'å…¨è‰¦ç„¡äººæ„ŸæŸ“ï¼Œä½†éŒ¯å¤±å¤–äº¤æ©Ÿæœƒã€‚', autoSuccess: true }, { title: 'é†«è¡“æ•‘æ´', requirement: { stat: 'knowledge', value: 6 }, requirementText: 'éœ€å­¸è­˜â‰¥6|è€—éŠ€30', cost: { silver: 30 }, effects: { trust: 20, morale: 10 }, failEffects: { trust: -15, morale: -20 }, successText: 'å¦™æ‰‹å›æ˜¥ï¼Œå¤§æ˜é†«è¡“æšåæµ·å¤–ã€‚', needsChallenge: true }, { title: 'å¿«é€Ÿè£œçµ¦', requirementText: 'è€—éŠ€20', cost: { silver: 20 }, effects: { trust: 0, morale: 5 }, successText: 'ç›¡å¿«é›¢é–‹äº†ç–«å€ã€‚', autoSuccess: true }] },
        { 
            stage: 10, locationId: 'bengal', icon: 'ğŸ¦’', title: 'æ¦œè‘›å‰Œãƒ»éº’éºŸ', description: 'åœ‹ç‹é€²è²¢ç¥ç¸ã€‚é•·é ¸ã€æ–‘ç´‹...é€™çœŸçš„æ˜¯éº’éºŸå—ï¼Ÿ', 
            choices: [
                { title: 'å­¸è­˜é‘‘å®š', requirement: { stat: 'knowledge', value: 5 }, requirementText: 'éœ€å­¸è­˜â‰¥5', effects: { trust: 20, morale: 15, qilin: true }, failEffects: { trust: -20, morale: -5 }, successText: 'ç¢ºèªç‚ºç¥¥ç‘éº’éºŸï¼', failText: 'ç„¡æ³•ç¢ºèªï¼ŒéŒ¯å¤±è‰¯æ©Ÿï¼Œçš‡å¸å¤§å¤±æ‰€æœ›ã€‚', needsChallenge: true, isQilinEvent: true }, 
                { title: 'æ¥å—é€²è²¢', requirement: { stat: 'connections', value: 5 }, requirementText: 'éœ€äººè„ˆâ‰¥5', effects: { trust: 10, morale: 10 }, successText: 'å¸¶å›çç¦½ç•°ç¸ï¼Œçš‡å¸é‚„ç®—æ»¿æ„ã€‚', autoSuccess: true },
                { title: 'ã€è¬¹æ…è¡Œäº‹ã€‘åªæ¥å—è²¢å“', effects: { trust: -5, morale: 5 }, successText: 'ç©©å¦¥èµ·è¦‹ï¼Œä¸å¸¶å›æœªçŸ¥å‹•ç‰©ï¼ŒéŒ¯å¤±ç¥¥ç‘ã€‚', autoSuccess: true }
            ] 
        }
      ];

      // --- SERVICES ---

      const ai = new GoogleGenAI({ apiKey: process.env.API_KEY || '' });

      const SYSTEM_INSTRUCTION = `
      ä½ æ˜¯ä¸€ä½ç²¾é€šæ˜æœæ­·å²å’Œé„­å’Œä¸‹è¥¿æ´‹ï¼ˆä¸‰å¯¶å¤ªç›£ï¼‰çš„å°ˆå®¶å²å®˜ã€‚
      ä½ æ­£åœ¨ç‚ºä¸€æ¬¾3Däº¤äº’å¼å†’éšªéŠæˆ²æä¾›èƒŒæ™¯ä¿¡æ¯ã€‚
      ä½ çš„å›ç­”æ‡‰ç•¶ä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼Œèªæ°£å¤é›…ä½†æ˜“æ‡‚ï¼Œå¯Œæœ‰æ•™è‚²æ„ç¾©ä¸”å¼•äººå…¥å‹ã€‚
      ç•¶è¢«å•åŠæŸå€‹åœ°é»æ™‚ï¼Œè§£é‡‹å…¶å°å¯¶èˆ¹è‰¦éšŠçš„é‡è¦æ€§ï¼Œäº¤æ˜“äº†ä»€éº¼ï¼Œä»¥åŠç™¼ç”Ÿäº†ä»€éº¼é‡å¤§äº‹ä»¶ï¼ˆæˆ°å½¹ã€å¤–äº¤ï¼‰ã€‚
      å¦‚æœç”¨æˆ¶å•ä¸€èˆ¬æ€§å•é¡Œï¼Œè«‹ä»¥åšå­¸çš„è‰¦éšŠå­¸è€…çš„å£å»å›ç­”ã€‚
      `;

      const getLocationDetails = async (location) => {
        try {
          const response = await ai.models.generateContent({
            model: 'gemini-3-flash-preview',
            contents: `è«‹æè¿° ${location.nameCn} (${location.name}) åœ¨é„­å’Œä¸‹è¥¿æ´‹ä¸­çš„æ­·å²é‡è¦æ€§ã€‚æåŠè²¿æ˜“å•†å“å’Œå¤–äº¤é—œä¿‚ã€‚ä¿æŒåœ¨150å­—ä»¥å…§ã€‚ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚`,
            config: {
              systemInstruction: SYSTEM_INSTRUCTION,
            }
          });
          return response.text || "æš«ç„¡è©³ç´°ä¿¡æ¯ã€‚";
        } catch (error) {
          console.error("Gemini Error:", error);
          return "ç„¡æ³•ç²å–è‰¦éšŠæª”æ¡ˆã€‚è«‹æª¢æŸ¥æ‚¨çš„ç¶²çµ¡é€£æ¥æˆ–APIé‡‘é‘°ã€‚";
        }
      };

      const chatWithHistorian = async (history, message) => {
        try {
          const chat = ai.chats.create({
            model: 'gemini-3-flash-preview',
            config: {
              systemInstruction: SYSTEM_INSTRUCTION,
            },
            history: history
          });

          const response = await chat.sendMessage({ message });
          return response.text || "æˆ‘ç¾åœ¨ç„¡æ³•å›ç­”é€™å€‹å•é¡Œã€‚";
        } catch (error) {
          console.error("Gemini Chat Error:", error);
          return "èˆ‡éš¨èˆ¹å²å®˜çš„é€šè¨Šä¸­æ–·ã€‚";
        }
      };

      // --- COMPONENTS ---

      const GlobeViz = ({ locations, routes, activeLocationId }) => {
        const globeEl = useRef(undefined);
        const [dimensions, setDimensions] = useState({ width: window.innerWidth, height: window.innerHeight });

        useEffect(() => {
          const handleResize = () => {
            setDimensions({ width: window.innerWidth, height: window.innerHeight });
          };
          window.addEventListener('resize', handleResize);
          return () => window.removeEventListener('resize', handleResize);
        }, []);

        useEffect(() => {
          if (activeLocationId && globeEl.current) {
              const loc = locations.find(l => l.id === activeLocationId);
              if (loc) {
                  globeEl.current.pointOfView({ lat: loc.lat, lng: loc.lng, altitude: 2.0 }, 2000);
              }
          }
        }, [activeLocationId, locations]);

        useEffect(() => {
          if (globeEl.current && !activeLocationId) {
            globeEl.current.pointOfView({ lat: 15, lng: 100, altitude: 2.5 }, 1000);
            globeEl.current.controls().autoRotate = true;
            globeEl.current.controls().autoRotateSpeed = 0.5;
          } else if (globeEl.current && activeLocationId) {
             globeEl.current.controls().autoRotate = false;
          }
        }, []);

        const arcsData = useMemo(() => {
          return routes.map(route => {
            const startLoc = locations.find(l => l.id === route.start);
            const endLoc = locations.find(l => l.id === route.end);
            if (!startLoc || !endLoc) return null;

            return {
              startLat: startLoc.lat,
              startLng: startLoc.lng,
              endLat: endLoc.lat,
              endLng: endLoc.lng,
              color: ['#C5A059', '#8B1E1E'],
            };
          }).filter(Boolean);
        }, [routes, locations]);

        return (
          <div className="absolute inset-0 z-0 cursor-move">
            <Globe
              ref={globeEl}
              width={dimensions.width}
              height={dimensions.height}
              backgroundColor="rgba(0,0,0,0)"
              globeImageUrl="//unpkg.com/three-globe/example/img/earth-blue-marble.jpg"
              bumpImageUrl="//unpkg.com/three-globe/example/img/earth-topology.png"
              htmlElementsData={locations}
              htmlElement={(d) => {
                const el = document.createElement('div');
                const isSelected = d.id === activeLocationId;
                el.innerHTML = `
                  <div style="
                    display: flex; 
                    flex-direction: column; 
                    align-items: center; 
                    transform: translate(-50%, -50%);
                    cursor: pointer;
                  ">
                    <div style="
                      font-family: 'Noto Serif TC', serif; 
                      color: ${isSelected ? '#FFD700' : '#F0E6D2'}; 
                      font-weight: bold; 
                      font-size: ${isSelected ? '18px' : '14px'};
                      text-shadow: 2px 2px 4px #000;
                      white-space: nowrap;
                      margin-bottom: 4px;
                    ">${d.nameCn}</div>
                    <div style="
                      width: ${isSelected ? '12px' : '8px'}; 
                      height: ${isSelected ? '12px' : '8px'}; 
                      background: ${isSelected ? '#FF4444' : '#C5A059'}; 
                      border-radius: 50%; 
                      border: 2px solid white;
                      box-shadow: 0 0 10px ${isSelected ? '#FF4444' : 'black'};
                    "></div>
                  </div>
                `;
                return el;
              }}
              arcsData={arcsData || []}
              arcColor="color"
              arcDashLength={0.4}
              arcDashGap={0.2}
              arcDashAnimateTime={2000}
              arcStroke={0.8}
              atmosphereColor="#3a7bd5"
              atmosphereAltitude={0.15}
            />
          </div>
        );
      };

      const InfoPanel = ({ location }) => {
        const [aiContent, setAiContent] = useState('');
        const [loading, setLoading] = useState(false);

        useEffect(() => {
          if (location) {
            setLoading(true);
            setAiContent('');
            getLocationDetails(location).then(text => {
              setAiContent(text);
              setLoading(false);
            });
          }
        }, [location]);

        if (!location) return null;

        return (
          <div className="bg-imperial-parchment border-2 border-imperial-ink/20 rounded-lg p-4 shadow-[0_4px_20px_rgba(0,0,0,0.3)] max-w-sm w-full animate-fadeIn text-imperial-ink relative overflow-hidden">
            <div className="absolute inset-0 bg-imperial-gold/5 pointer-events-none"></div>

            <div className="relative flex items-center gap-2 mb-3 border-b border-imperial-ink/20 pb-2">
              <MapPin className="text-imperial-red" size={20} />
              <h3 className="text-xl font-serif font-bold text-imperial-ink">{location.nameCn}</h3>
            </div>

            <div className="relative mb-4">
              <span className="text-xs uppercase text-imperial-ink/60 font-bold block mb-1">ç‰¹ç”¢</span>
              <div className="flex gap-2 flex-wrap">
                {location.tradeGoods.map(good => (
                  <span key={good} className="px-2 py-1 bg-white/50 border border-imperial-ink/20 rounded text-xs text-imperial-ink font-serif flex items-center gap-1 shadow-sm">
                    <Box size={12} className="text-imperial-gold" /> {good}
                  </span>
                ))}
              </div>
            </div>

            <div className="relative">
              <div className="flex items-center gap-2 mb-2">
                <Ship size={16} className="text-imperial-gold" />
                <h4 className="text-sm font-bold text-imperial-ink">å²å®˜è€ƒè­‰</h4>
              </div>
              
              {loading ? (
                <div className="flex items-center gap-2 text-imperial-ink/50 text-sm h-20">
                   <Loader2 size={14} className="animate-spin" /> æŸ¥è©¢æª”æ¡ˆä¸­...
                </div>
              ) : (
                <p className="text-sm text-imperial-ink/80 leading-relaxed font-serif bg-white/30 p-2 rounded">
                  {aiContent}
                </p>
              )}
            </div>
          </div>
        );
      };

      const ChatInterface = () => {
        const [isOpen, setIsOpen] = useState(false);
        const [messages, setMessages] = useState([
          { id: '1', role: 'model', text: 'æ‚¨å¥½ã€‚æˆ‘æ˜¯éš¨èˆ¹å²å®˜ã€‚é—œæ–¼è‰¦éšŠçš„æ±ºç­–æˆ–é¢¨åœŸäººæƒ…ï¼Œæ‚¨å„˜ç®¡å•ã€‚' }
        ]);
        const [input, setInput] = useState('');
        const [loading, setLoading] = useState(false);
        const scrollRef = useRef(null);

        useEffect(() => {
          if (scrollRef.current) {
            scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
          }
        }, [messages, isOpen]);

        const handleSend = async () => {
          if (!input.trim() || loading) return;

          const userMsg = { id: Date.now().toString(), role: 'user', text: input };
          setMessages(prev => [...prev, userMsg]);
          setInput('');
          setLoading(true);

          const history = messages.map(m => ({
            role: m.role,
            parts: [{ text: m.text }]
          }));

          const responseText = await chatWithHistorian(history, userMsg.text);
          
          setMessages(prev => [...prev, { id: (Date.now() + 1).toString(), role: 'model', text: responseText }]);
          setLoading(false);
        };

        if (!isOpen) {
          return (
            <button 
              onClick={() => setIsOpen(true)}
              className="fixed bottom-6 right-6 z-50 bg-imperial-gold hover:bg-yellow-600 text-imperial-ink font-bold p-4 rounded-full shadow-xl transition-transform hover:scale-105 flex items-center gap-2 border-2 border-imperial-parchment"
            >
              <MessageSquare size={24} />
              <span className="hidden md:inline font-serif">è©¢å•å²å®˜</span>
            </button>
          );
        }

        return (
          <div className="fixed bottom-6 right-6 z-50 w-[90vw] md:w-96 h-[400px] flex flex-col bg-imperial-parchment text-imperial-ink rounded-xl border-2 border-imperial-ink/30 shadow-2xl overflow-hidden font-serif">
            <div className="flex items-center justify-between p-4 border-b border-imperial-ink/10 bg-imperial-gold/20">
              <h3 className="font-bold text-imperial-ink flex items-center gap-2">
                <span className="text-xl">ğŸ“œ</span> éš¨èˆ¹å²å®˜
              </h3>
              <button onClick={() => setIsOpen(false)} className="text-imperial-ink/50 hover:text-imperial-red transition-colors">
                <X size={18} />
              </button>
            </div>

            <div ref={scrollRef} className="flex-1 overflow-y-auto p-4 space-y-4 bg-imperial-parchment">
              {messages.map((msg) => (
                <div key={msg.id} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                  <div className={`max-w-[85%] rounded-lg p-3 text-sm shadow-sm ${
                    msg.role === 'user' 
                      ? 'bg-imperial-ocean text-white' 
                      : 'bg-white border border-imperial-ink/10 text-imperial-ink'
                  }`}>
                    {msg.text}
                  </div>
                </div>
              ))}
              {loading && (
                <div className="flex justify-start">
                  <div className="bg-white/50 text-imperial-ink/60 rounded-lg p-3 text-sm flex items-center gap-2">
                    <Loader2 size={14} className="animate-spin" /> æŸ¥é–±æª”æ¡ˆä¸­...
                  </div>
                </div>
              )}
            </div>

            <div className="p-4 border-t border-imperial-ink/10 bg-white/50">
              <div className="flex items-center gap-2">
                <input 
                  type="text" 
                  value={input}
                  onChange={(e) => setInput(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && handleSend()}
                  placeholder="è©¢å•..."
                  className="flex-1 bg-white border border-imperial-ink/20 text-imperial-ink rounded-md px-3 py-2 text-sm focus:outline-none focus:border-imperial-gold"
                />
                <button 
                  onClick={handleSend}
                  disabled={loading}
                  className="bg-imperial-gold text-imperial-ink p-2 rounded-md hover:bg-yellow-600 disabled:opacity-50"
                >
                  <Send size={18} />
                </button>
              </div>
            </div>
          </div>
        );
      };

      // --- APP COMPONENT ---

      const INITIAL_STATS = {
        trust: 50,
        morale: 50,
        knowledge: 0,
        connections: 0,
        silver: 50,
        hasQilin: false,
        timeRemaining: 1800
      };

      const ModalWrapper = ({ children }) => (
        <div className="absolute inset-0 z-50 flex items-center justify-center bg-imperial-ocean/60 backdrop-blur-sm p-4 animate-fadeIn">
           {children}
        </div>
      );

      const PaperCard = ({ children, className = "" }) => (
        <div className={`bg-imperial-parchment border-2 border-imperial-ink/30 rounded-xl shadow-2xl relative overflow-hidden text-imperial-ink font-serif ${className}`}>
            <div className="absolute inset-0 bg-imperial-gold/5 pointer-events-none"></div>
            <div className="relative z-10">{children}</div>
        </div>
      );

      const App = () => {
        const [phase, setPhase] = useState('intro');
        const [stats, setStats] = useState(INITIAL_STATS);
        const [currentEventIndex, setCurrentEventIndex] = useState(0);
        const [currentEvent, setCurrentEvent] = useState(null);
        const [isUiMinimized, setIsUiMinimized] = useState(false);
        
        const [quizQuestions, setQuizQuestions] = useState([]);
        const [currentQuizIndex, setCurrentQuizIndex] = useState(0);
        const [quizScore, setQuizScore] = useState(0);
        const [quizFeedback, setQuizFeedback] = useState(null);

        const [pendingChoice, setPendingChoice] = useState(null);
        const [activeChallengeQuestion, setActiveChallengeQuestion] = useState(null);
        const [resultMessage, setResultMessage] = useState(null);
        const [usedQuizIndices, setUsedQuizIndices] = useState([]);

        useEffect(() => {
          if (phase === 'playing' && stats.timeRemaining > 0) {
            const timer = setInterval(() => {
              setStats(prev => {
                if (prev.timeRemaining <= 1) {
                   setPhase('gameover');
                   setResultMessage({success: false, text: "æ™‚é–“è€—ç›¡ï¼Œè‰¦éšŠæœªèƒ½æŒ‰æ™‚è¿”èˆªã€‚", changes: []});
                   return prev;
                }
                return { ...prev, timeRemaining: prev.timeRemaining - 1 };
              });
            }, 1000);
            return () => clearInterval(timer);
          }
        }, [phase, stats.timeRemaining]);

        useEffect(() => {
          if (phase === 'playing') {
            if (stats.trust <= 0) {
              setPhase('gameover');
              setResultMessage({success: false, text: "çš‡å¸éœ‡æ€’ï¼Œä¸‹ä»¤å¬å›è‰¦éšŠï¼Œå°‡ä½ é©è·æŸ¥è¾¦ã€‚", changes: []});
            } else if (stats.morale <= 0) {
              setPhase('gameover');
              setResultMessage({success: false, text: "æ°´æ‰‹è­è®Šï¼Œè‰¦éšŠåˆ†å´©é›¢æã€‚", changes: []});
            }
          }
        }, [stats, phase]);

        const shuffleQuiz = () => {
          const shuffled = [...QUIZ_QUESTIONS].sort(() => 0.5 - Math.random());
          setQuizQuestions(shuffled.slice(0, 5));
          setUsedQuizIndices(shuffled.slice(0, 5).map(q => QUIZ_QUESTIONS.indexOf(q)));
        };

        const startQuiz = () => {
          shuffleQuiz();
          setPhase('quiz');
        };

        const handleQuizAnswer = (idx) => {
          const q = quizQuestions[currentQuizIndex];
          const isCorrect = idx === q.correct;
          if (isCorrect) setQuizScore(s => s + 1);
          setQuizFeedback({
            correct: isCorrect,
            text: q.explanation
          });
        };

        const nextQuizQuestion = () => {
          setQuizFeedback(null);
          if (currentQuizIndex < 4) {
            setCurrentQuizIndex(i => i + 1);
          } else {
            finishQuiz();
          }
        };

        const finishQuiz = () => {
          const baseStats = { ...INITIAL_STATS };
          baseStats.trust = 50 + quizScore * 5;
          baseStats.morale = 60 + quizScore * 5;
          baseStats.silver = 80 + quizScore * 10;
          
          if (quizScore === 5) {
            baseStats.knowledge = 5;
            baseStats.connections = 5;
          } else {
            baseStats.knowledge = 2 + Math.floor(quizScore / 2);
            baseStats.connections = 2 + Math.floor(quizScore / 2);
          }
          
          setStats(baseStats);
          setPhase('playing');
          loadEvent(0);
        };

        const loadEvent = (idx) => {
          if (idx >= GAME_EVENTS.length) {
            finishGame();
            return;
          }
          setCurrentEventIndex(idx);
          setCurrentEvent(GAME_EVENTS[idx]);
        };

        const handleChoice = (choice) => {
          if (choice.cost && stats.silver < choice.cost.silver) return;

          if (choice.cost) {
            setStats(s => ({...s, silver: s.silver - choice.cost.silver}));
          }

          if (choice.needsChallenge) {
            setPendingChoice(choice);
            const availableIndices = QUIZ_QUESTIONS.map((_, i) => i).filter(i => !usedQuizIndices.includes(i));
            const nextIdx = availableIndices.length > 0 
              ? availableIndices[Math.floor(Math.random() * availableIndices.length)] 
              : Math.floor(Math.random() * QUIZ_QUESTIONS.length);
            
            setUsedQuizIndices(prev => [...prev, nextIdx]);
            setActiveChallengeQuestion(QUIZ_QUESTIONS[nextIdx]);
            setPhase('challenge');
          } else {
            applyEffects(choice.effects, choice.successText, true, choice.isQilinEvent);
          }
        };

        const handleChallengeAnswer = (idx) => {
          if (!activeChallengeQuestion || !pendingChoice) return;
          const isCorrect = idx === activeChallengeQuestion.correct;
          
          setQuizFeedback({
              correct: isCorrect,
              text: activeChallengeQuestion.explanation
          });

          setTimeout(() => {
              setQuizFeedback(null);
              if (isCorrect) {
                applyEffects(pendingChoice.effects, pendingChoice.successText, true, pendingChoice.isQilinEvent);
              } else {
                applyEffects(pendingChoice.failEffects || {}, pendingChoice.failText || "åˆ¤å®šå¤±æ•—", false, false);
              }
          }, 2000);
        };

        const applyEffects = (effects, text, success, isQilin = false) => {
          const changes = [];
          setStats(prev => {
            const next = { ...prev };
            if (effects.trust) { next.trust = Math.min(100, Math.max(0, next.trust + effects.trust)); changes.push(`ä¿¡ä»» ${effects.trust > 0 ? '+' : ''}${effects.trust}`); }
            if (effects.morale) { next.morale = Math.min(100, Math.max(0, next.morale + effects.morale)); changes.push(`å£«æ°£ ${effects.morale > 0 ? '+' : ''}${effects.morale}`); }
            if (effects.knowledge) { next.knowledge += effects.knowledge; changes.push(`å­¸è­˜ +${effects.knowledge}`); }
            if (effects.connections) { next.connections += effects.connections; changes.push(`äººè„ˆ +${effects.connections}`); }
            if (effects.silver) { next.silver += effects.silver; changes.push(`éŠ€å…© ${effects.silver > 0 ? '+' : ''}${effects.silver}`); }
            if (success && isQilin) { next.hasQilin = true; changes.push("ç²å¾—éº’éºŸï¼"); }
            return next;
          });

          setResultMessage({ success, text, changes });
          setPhase('result');
        };

        const nextTurn = () => {
          setPhase('playing');
          setResultMessage(null);
          setPendingChoice(null);
          loadEvent(currentEventIndex + 1);
        };

        const finishGame = () => {
          setPhase('victory');
        };

        const formatTime = (sec) => {
          const m = Math.floor(sec / 60);
          const s = sec % 60;
          return `${m}:${s < 10 ? '0' + s : s}`;
        };

        const getFinalGrade = () => {
          if (stats.trust >= 90 && stats.hasQilin && stats.morale >= 80) return 'S';
          if (stats.trust >= 80) return 'A';
          if (stats.trust >= 60) return 'B';
          return 'C';
        };

        return (
          <div className="relative w-full h-screen overflow-hidden font-sans">
            <GlobeViz 
              locations={LOCATIONS} 
              routes={ROUTES} 
              activeLocationId={currentEvent?.locationId}
            />

            {(phase === 'playing' || phase === 'result' || phase === 'challenge') && (
              <div className="absolute top-0 left-0 right-0 z-30 pointer-events-none">
                <div className="absolute inset-0 h-32 bg-gradient-to-b from-imperial-ocean/90 to-transparent pointer-events-none" />
                
                <div className="relative flex flex-col md:flex-row items-start md:items-center justify-between p-4 max-w-7xl mx-auto w-full gap-4">
                   <div className="flex flex-col gap-2 w-full md:w-auto pointer-events-auto">
                      <div className="flex items-center gap-4 bg-imperial-parchment/90 backdrop-blur-md p-2 rounded-lg border border-imperial-ink/20 shadow-lg text-imperial-ink">
                          <div className="flex items-center gap-2 px-2">
                              <Clock size={18} className="text-imperial-red" />
                              <span className={`font-mono font-bold text-lg ${stats.timeRemaining < 180 ? 'text-imperial-red animate-pulse' : 'text-imperial-ink'}`}>
                                  {formatTime(stats.timeRemaining)}
                              </span>
                          </div>
                          <div className="h-8 w-[1px] bg-imperial-ink/20"></div>
                          <div className="flex gap-4 px-2">
                              <div className="flex flex-col">
                                  <span className="text-[10px] text-imperial-ink/60 uppercase tracking-wider font-bold">çš‡å¸ä¿¡ä»»</span>
                                  <div className="flex items-center gap-2">
                                      <div className="w-24 h-2 bg-imperial-ink/10 rounded-full overflow-hidden border border-imperial-ink/10">
                                          <div className="h-full bg-game-trust transition-all duration-500" style={{width: `${stats.trust}%`}}></div>
                                      </div>
                                      <span className="text-xs font-bold">{stats.trust}</span>
                                  </div>
                              </div>
                              <div className="flex flex-col">
                                  <span className="text-[10px] text-imperial-ink/60 uppercase tracking-wider font-bold">éƒ¨ä¸‹å£«æ°£</span>
                                  <div className="flex items-center gap-2">
                                      <div className="w-24 h-2 bg-imperial-ink/10 rounded-full overflow-hidden border border-imperial-ink/10">
                                          <div className="h-full bg-game-morale transition-all duration-500" style={{width: `${stats.morale}%`}}></div>
                                      </div>
                                      <span className="text-xs font-bold">{stats.morale}</span>
                                  </div>
                              </div>
                          </div>
                      </div>
                   </div>

                   <div className="flex gap-3 text-xs md:text-sm pointer-events-auto bg-imperial-parchment/90 backdrop-blur-md p-2 rounded-lg border border-imperial-ink/20 shadow-lg font-serif font-bold text-imperial-ink">
                      <span className="flex items-center gap-1 px-2"><span className="text-imperial-gold text-lg">ğŸ“œ</span> å­¸è­˜ {stats.knowledge}</span>
                      <span className="flex items-center gap-1 px-2 border-l border-imperial-ink/10"><span className="text-imperial-gold text-lg">ğŸ¤</span> äººè„ˆ {stats.connections}</span>
                      <span className="flex items-center gap-1 px-2 border-l border-imperial-ink/10"><span className="text-imperial-gold text-lg">ğŸ’°</span> éŠ€å…© {stats.silver}</span>
                      {stats.hasQilin && <span className="flex items-center gap-1 px-2 border-l border-imperial-ink/10 text-imperial-red font-bold">ğŸ¦’ éº’éºŸ</span>}
                   </div>
                </div>
              </div>
            )}

            {phase === 'playing' && currentEvent && (
                <div className="absolute top-28 right-4 z-20 pointer-events-none flex flex-col items-end gap-2">
                    <div className="pointer-events-auto">
                         <InfoPanel location={LOCATIONS.find(l => l.id === currentEvent.locationId) || null} />
                    </div>
                </div>
            )}

            {phase === 'playing' && currentEvent && (
              <div className={`absolute left-0 bottom-0 md:left-8 md:bottom-8 z-20 flex flex-col items-start p-2 md:p-0 pointer-events-none transition-all duration-500 ${isUiMinimized ? 'translate-y-[85%]' : 'translate-y-0'}`}>
                  <PaperCard className="pointer-events-auto max-w-md w-full">
                      <div className="p-6">
                          <button 
                              onClick={() => setIsUiMinimized(!isUiMinimized)}
                              className="absolute top-2 right-2 text-imperial-ink/40 hover:text-imperial-ink p-1 hover:bg-imperial-ink/5 rounded"
                          >
                              {isUiMinimized ? <Maximize2 size={16} /> : <Minimize2 size={16} />}
                          </button>

                          <div className="flex items-center gap-3 mb-4 border-b border-imperial-ink/10 pb-3 pr-8">
                              <span className="text-4xl filter drop-shadow-sm">{currentEvent.icon}</span>
                              <div>
                                  <div className="text-xs uppercase text-imperial-red font-bold tracking-widest mb-1">ç¬¬ {currentEvent.stage} èˆªæ®µ</div>
                                  <h2 className="text-2xl font-serif font-bold text-imperial-ink">{currentEvent.title}</h2>
                              </div>
                          </div>

                          <div className={`transition-opacity duration-300 ${isUiMinimized ? 'opacity-0 h-0 overflow-hidden' : 'opacity-100'}`}>
                              <p className="text-imperial-ink/80 mb-6 leading-relaxed text-base font-serif border-l-4 border-imperial-gold pl-3 bg-imperial-gold/5 py-2 rounded-r">
                                  {currentEvent.description}
                              </p>

                              <div className="grid gap-3">
                                  {currentEvent.choices.map((choice, i) => {
                                      const canAfford = !choice.cost || stats.silver >= choice.cost.silver;
                                      let reqMet = true;
                                      if (choice.requirement) {
                                          reqMet = stats[choice.requirement.stat] >= choice.requirement.value;
                                      }

                                      return (
                                          <button 
                                              key={i}
                                              onClick={() => handleChoice(choice)}
                                              disabled={!canAfford}
                                              className={`text-left p-3 rounded-lg border-2 transition-all group relative overflow-hidden ${
                                                  canAfford 
                                                  ? 'bg-white border-imperial-ink/10 hover:border-imperial-gold hover:shadow-md' 
                                                  : 'bg-gray-200 border-gray-300 opacity-60 cursor-not-allowed'
                                              }`}
                                          >
                                              <div className="flex justify-between items-center relative z-10">
                                                  <span className={`font-bold text-base font-serif ${canAfford ? 'group-hover:text-imperial-red' : ''} transition-colors`}>{choice.title}</span>
                                                  <div className="text-xs flex flex-col items-end gap-0.5 font-sans">
                                                      {choice.requirementText && (
                                                          <span className={`${reqMet ? 'text-game-morale' : 'text-imperial-red font-bold'}`}>
                                                              {choice.requirementText}
                                                          </span>
                                                      )}
                                                      {choice.cost && (
                                                          <span className={`${canAfford ? 'text-imperial-gold' : 'text-imperial-red font-bold'}`}>
                                                              è€—éŠ€ {choice.cost.silver}
                                                          </span>
                                                      )}
                                                  </div>
                                              </div>
                                          </button>
                                      );
                                  })}
                              </div>
                          </div>
                      </div>
                  </PaperCard>
              </div>
            )}

            {phase === 'intro' && (
              <ModalWrapper>
                <div className="max-w-2xl w-full text-center">
                  <h1 className="text-6xl md:text-8xl font-serif text-imperial-gold mb-2 drop-shadow-lg" style={{textShadow: '0 4px 10px rgba(0,0,0,0.5)'}}>å¤§æ˜é èˆª</h1>
                  <h2 className="text-3xl text-imperial-parchment mb-8 font-serif tracking-widest text-shadow-sm">éº’éºŸä¹‹èª“</h2>
                  
                  <PaperCard className="p-8 mb-8 text-left space-y-4 leading-relaxed text-lg">
                      <p>æ°¸æ¨‚ä¸‰å¹´ï¼Œå¤§æ˜çš‡å¸æœ±æ££å‘½ä½ å‡ºä½¿è¥¿æ´‹ã€‚æ­¤è¡Œè·¯é€”å‡¶éšªï¼Œä¼´å›å¦‚ä¼´è™ã€‚</p>
                      <p>ä½ å°‡ç¶“æ­·<strong className="text-imperial-red">åå€‹èˆªæ®µ</strong>ã€‚è«‹æ³¨æ„ï¼šçš‡å¸çš„è€å¿ƒæ˜¯æœ‰é™çš„ï¼Œä»»ä½•æœ‰æåœ‹å¨æˆ–å»¶èª¤è¡Œç¨‹çš„æ±ºå®šï¼Œéƒ½å¯èƒ½å°è‡´ä¿¡ä»»å´©å¡Œã€‚</p>
                      <p>å•Ÿèˆªå‰ï¼Œéœ€é€šé<strong className="text-imperial-gold bg-imperial-ink text-white px-2 py-0.5 rounded">æ­·å²çŸ¥è­˜æ¸¬è©¦</strong>æ±ºå®šåˆå§‹èƒ½åŠ›ï¼</p>
                  </PaperCard>

                  <button onClick={startQuiz} className="bg-imperial-gold text-imperial-ink font-bold py-3 px-10 rounded-full text-xl hover:bg-yellow-500 transition-all hover:scale-105 shadow-xl border-2 border-imperial-parchment">
                      é–‹å§‹æ¸¬è©¦
                  </button>
                </div>
              </ModalWrapper>
            )}

            {phase === 'quiz' && (
              <ModalWrapper>
                <PaperCard className="max-w-xl w-full p-8">
                  <div className="flex justify-between items-center mb-6 border-b border-imperial-ink/10 pb-4">
                      <h3 className="text-imperial-red text-2xl font-bold">èˆªæµ·çŸ¥è­˜æ¸¬è©¦</h3>
                      <span className="text-imperial-ink/50 font-bold">ç¬¬ {currentQuizIndex + 1} / 5 é¡Œ</span>
                  </div>
                  
                  <p className="text-xl mb-8 font-serif font-bold">{quizQuestions[currentQuizIndex]?.question}</p>
                  
                  <div className="space-y-3">
                      {quizQuestions[currentQuizIndex]?.options.map((opt, i) => (
                          <button 
                              key={i}
                              onClick={() => !quizFeedback && handleQuizAnswer(i)}
                              disabled={!!quizFeedback}
                              className={`w-full p-4 rounded-lg text-left border-2 transition-all font-serif text-lg ${
                                  quizFeedback 
                                      ? i === quizQuestions[currentQuizIndex].correct 
                                          ? 'bg-green-100 border-green-500 text-green-900' 
                                          : 'bg-gray-100 border-gray-300 opacity-50'
                                      : 'bg-white border-imperial-ink/10 hover:border-imperial-gold hover:bg-imperial-gold/5'
                              }`}
                          >
                              {opt}
                          </button>
                      ))}
                  </div>

                  {quizFeedback && (
                      <div className={`mt-6 p-4 rounded-lg border-2 ${quizFeedback.correct ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'} animate-fadeIn`}>
                          <p className="font-bold mb-1 text-lg">{quizFeedback.correct ? 'âœ… æ­£ç¢º' : 'âŒ éŒ¯èª¤'}</p>
                          <p className="">{quizFeedback.text}</p>
                          <button onClick={nextQuizQuestion} className="mt-4 w-full bg-imperial-gold text-imperial-ink font-bold py-2 rounded shadow-md hover:bg-yellow-500 transition-colors">
                              ä¸‹ä¸€é¡Œ
                          </button>
                      </div>
                  )}
                </PaperCard>
              </ModalWrapper>
            )}

            {phase === 'challenge' && activeChallengeQuestion && (
              <ModalWrapper>
                   <PaperCard className="max-w-lg w-full p-8 text-center border-imperial-red/50">
                      <AlertTriangle size={48} className="mx-auto text-imperial-red mb-4" />
                      <h3 className="text-2xl font-bold mb-2">å‘½é‹æŠ‰æ“‡ï¼šçŸ¥è­˜è€ƒé©—</h3>
                      <p className="text-imperial-ink/60 mb-6 text-sm">é€šéè€ƒé©—ä»¥åŸ·è¡Œæ­¤æ±ºç­–...</p>
                      
                      <p className="text-lg font-serif mb-6 text-left font-bold">{activeChallengeQuestion.question}</p>
                      
                      <div className="space-y-3">
                          {activeChallengeQuestion.options.map((opt, i) => (
                              <button
                                  key={i}
                                  onClick={() => !quizFeedback && handleChallengeAnswer(i)}
                                  className={`w-full p-3 rounded border-2 text-left font-serif ${
                                      quizFeedback 
                                      ? i === activeChallengeQuestion.correct 
                                          ? 'bg-green-100 border-green-500 text-green-900' 
                                          : 'bg-gray-100 border-gray-300 opacity-50'
                                      : 'bg-white border-imperial-ink/20 hover:border-imperial-gold'
                                  }`}
                              >
                                  {opt}
                              </button>
                          ))}
                      </div>
                      {quizFeedback && (
                          <div className="mt-4 text-sm text-imperial-ink/80 animate-fadeIn bg-imperial-gold/10 p-2 rounded">
                              {quizFeedback.text}
                          </div>
                      )}
                   </PaperCard>
              </ModalWrapper>
            )}

            {phase === 'result' && resultMessage && (
              <ModalWrapper>
                  <PaperCard className="max-w-md w-full p-8 text-center">
                      <div className="text-6xl mb-4">{resultMessage.success ? 'âœ…' : 'âš ï¸'}</div>
                      <h3 className={`text-2xl font-bold mb-4 ${resultMessage.success ? 'text-game-morale' : 'text-game-trust'}`}>
                          {resultMessage.success ? 'åŸ·è¡ŒæˆåŠŸ' : 'é­é‡å›°é›£'}
                      </h3>
                      <p className="text-imperial-ink mb-6 leading-relaxed text-lg">{resultMessage.text}</p>
                      
                      <div className="flex flex-wrap justify-center gap-2 mb-8">
                          {resultMessage.changes.map((c, i) => (
                              <span key={i} className={`px-2 py-1 rounded text-sm font-bold border ${c.includes('+') ? 'border-game-morale text-game-morale bg-game-morale/10' : 'border-game-trust text-game-trust bg-game-trust/10'}`}>
                                  {c}
                              </span>
                          ))}
                      </div>

                      <button onClick={nextTurn} className="bg-imperial-gold text-imperial-ink font-bold py-3 px-8 rounded-full hover:bg-yellow-500 w-full transition-transform hover:scale-105 shadow-md">
                          ç¹¼çºŒèˆªè¡Œ
                      </button>
                  </PaperCard>
              </ModalWrapper>
            )}

            {(phase === 'victory' || phase === 'gameover') && (
              <ModalWrapper>
                   <PaperCard className="max-w-2xl w-full p-8 text-center border-4 border-imperial-gold">
                      {phase === 'victory' ? (
                          <>
                              <div className="text-8xl font-serif text-imperial-red mb-2 drop-shadow-sm font-bold">
                                  {getFinalGrade()}
                              </div>
                              <h2 className="text-3xl font-bold text-imperial-ink mb-6">èˆªè¡ŒçµæŸ</h2>
                              <div className="bg-white/50 rounded-lg p-6 mb-8 text-left space-y-2 border border-imperial-ink/10">
                                   <p className="text-lg">æœ€çµ‚ä¿¡ä»»: <span className="text-imperial-red font-bold">{stats.trust}</span></p>
                                   <p className="text-lg">æœ€çµ‚å£«æ°£: <span className="text-game-morale font-bold">{stats.morale}</span></p>
                                   <p className="text-lg">éº’éºŸç¥¥ç‘: {stats.hasQilin ? 'ğŸ¦’ å·²å¸¶å›' : 'âŒ æœªç²å¾—'}</p>
                                   <hr className="border-imperial-ink/20 my-4"/>
                                   <p className="italic text-imperial-ink/70">
                                      {getFinalGrade() === 'S' && "æœ€é«˜æ¦®è€€ï¼ä½ å¸¶å›äº†éº’éºŸï¼Œè±¡å¾µåœ‹åŠ›å¼·ç››ã€‚é„­å’Œä¸‹è¥¿æ´‹ä¸åƒ…æ˜¯èˆªæµ·å£¯èˆ‰ï¼Œæ›´æ˜¯å’Œå¹³å¤–äº¤çš„å…¸ç¯„ã€‚"}
                                      {getFinalGrade() === 'A' && "å…‰æ¦®æ­¸èˆªã€‚é›–ç„¡éº’éºŸï¼Œä½†å¤–äº¤æˆæœè±ç¢©ï¼Œå±•ç¾äº†å’Œå¹³å´›èµ·çš„ç†å¿µã€‚"}
                                      {getFinalGrade() === 'B' && "å¹³å®‰æ­¸ä¾†ã€‚èˆªè¡Œé›–æœ‰æ³¢æŠ˜ï¼Œä½†æœ€çµ‚å¹³å®‰ã€‚æµ·æ´‹æ”¿ç­–çš„èˆˆè¡°å€¼å¾—æ·±æ€ã€‚"}
                                      {getFinalGrade() === 'C' && "å‹‰å¼·åŠæ ¼ã€‚æå¤±ä¸å°ï¼Œæ±ºç­–éœ€æ›´å‘¨å…¨ã€‚"}
                                   </p>
                              </div>
                          </>
                      ) : (
                          <>
                              <Skull size={80} className="mx-auto text-imperial-ink/80 mb-6" />
                              <h2 className="text-3xl font-bold text-imperial-red mb-4">èˆªè¡Œå¤±æ•—</h2>
                              <p className="text-xl text-imperial-ink mb-8">{resultMessage?.text}</p>
                          </>
                      )}
                      
                      <button onClick={() => window.location.reload()} className="bg-imperial-gold text-imperial-ink font-bold py-3 px-8 rounded-full hover:bg-yellow-500 transition-transform hover:scale-105 shadow-xl">
                          é‡æ–°æŒ‘æˆ°
                      </button>
                   </PaperCard>
              </ModalWrapper>
            )}

            <ChatInterface />
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  </body>
</html>